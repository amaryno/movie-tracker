version: "3.8"

services:
 jenkins:
  image: jenkins/jenkins:lts
  container_name: jenkins-movie-tracker
  user: root
  ports:
   - "8080:8080"
   - "50000:50000"
  volumes:
   - jenkins_home:/var/jenkins_home
   - /var/run/docker.sock:/var/run/docker.sock
  environment:
   - JENKINS_OPTS=--httpPort=8080
   - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
  networks:
   - jenkins-network
  restart: unless-stopped

 # Optional: SonarQube for code quality analysis
 sonarqube:
  image: sonarqube:community
  container_name: sonarqube-movie-tracker
  ports:
   - "9000:9000"
  environment:
   - SONAR_JDBC_URL=jdbc:postgresql://postgres-sonar:5432/sonar
   - SONAR_JDBC_USERNAME=sonar
   - SONAR_JDBC_PASSWORD=sonar
  volumes:
   - sonarqube_data:/opt/sonarqube/data
   - sonarqube_logs:/opt/sonarqube/logs
   - sonarqube_extensions:/opt/sonarqube/extensions
  networks:
   - jenkins-network
  depends_on:
   - postgres-sonar

 # PostgreSQL for SonarQube
 postgres-sonar:
  image: postgres:13
  container_name: postgres-sonar
  environment:
   - POSTGRES_USER=sonar
   - POSTGRES_PASSWORD=sonar
   - POSTGRES_DB=sonar
  volumes:
   - postgresql_sonar:/var/lib/postgresql/data
  networks:
   - jenkins-network

volumes:
 jenkins_home:
  driver: local
 sonarqube_data:
  driver: local
 sonarqube_logs:
  driver: local
 sonarqube_extensions:
  driver: local
 postgresql_sonar:
  driver: local

networks:
 jenkins-network:
  driver: bridge
