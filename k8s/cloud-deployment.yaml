apiVersion: v1
kind: Namespace
metadata:
 name: movie-tracker
---
# PostgreSQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
 name: postgres
 namespace: movie-tracker
spec:
 replicas: 1
 selector:
  matchLabels:
   app: postgres
 template:
  metadata:
   labels:
    app: postgres
  spec:
   containers:
    - name: postgres
      image: postgres:13
      env:
       - name: POSTGRES_DB
         value: "moviesdb"
       - name: POSTGRES_USER
         value: "movieuser"
       - name: POSTGRES_PASSWORD
         value: "password123"
      ports:
       - containerPort: 5432
      volumeMounts:
       - name: postgres-storage
         mountPath: /var/lib/postgresql/data
   volumes:
    - name: postgres-storage
      emptyDir: {}
---
# PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
 name: postgres
 namespace: movie-tracker
spec:
 type: ClusterIP
 selector:
  app: postgres
 ports:
  - port: 5432
    targetPort: 5432
---
# Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
 name: backend
 namespace: movie-tracker
spec:
 replicas: 2
 selector:
  matchLabels:
   app: backend
 template:
  metadata:
   labels:
    app: backend
  spec:
   containers:
    - name: backend
      image: amarynow/movie-tracker-backend:latest
      imagePullPolicy: Always
      ports:
       - containerPort: 8000
      env:
       - name: DB_HOST
         value: "postgres"
       - name: DB_PORT
         value: "5432"
       - name: DB_NAME
         value: "moviesdb"
       - name: DB_USER
         value: "movieuser"
       - name: DB_PASSWORD
         value: "password123"
      livenessProbe:
       httpGet:
        path: /
        port: 8000
       initialDelaySeconds: 30
       periodSeconds: 10
      readinessProbe:
       httpGet:
        path: /
        port: 8000
       initialDelaySeconds: 5
       periodSeconds: 5
---
# Backend Service
apiVersion: v1
kind: Service
metadata:
 name: backend
 namespace: movie-tracker
spec:
 type: ClusterIP
 selector:
  app: backend
 ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
---
# Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
 name: frontend
 namespace: movie-tracker
spec:
 replicas: 2
 selector:
  matchLabels:
   app: frontend
 template:
  metadata:
   labels:
    app: frontend
  spec:
   containers:
    - name: frontend
      image: amarynow/movie-tracker-frontend:latest
      imagePullPolicy: Always
      env:
       - name: API_URL
         value: "http://backend:8000"
      ports:
       - containerPort: 80
      livenessProbe:
       httpGet:
        path: /
        port: 80
       initialDelaySeconds: 30
       periodSeconds: 10
      readinessProbe:
       httpGet:
        path: /
        port: 80
       initialDelaySeconds: 5
       periodSeconds: 5
---
# Frontend Service (LoadBalancer for external access)
apiVersion: v1
kind: Service
metadata:
 name: frontend
 namespace: movie-tracker
spec:
 type: LoadBalancer
 selector:
  app: frontend
 ports:
  - port: 80
    targetPort: 80
